name: Dispatch Preflight

on:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes (UTC)
  workflow_dispatch: {}

concurrency:
  group: dispatch-preflight
  cancel-in-progress: false

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Call dispatch_preflight
        env:
          URL: ${{ secrets.SUPABASE_DISPATCH_PREFLIGHT_URL }}
          SECRET: ${{ secrets.DISPATCH_SECRET }}
        run: |
          set -euo pipefail
          curl -fsS "$URL" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "x-dispatch-secret: $SECRET" \
            -d '{"limit":25}' \
            --retry 3 --retry-all-errors --connect-timeout 10 --max-time 30
